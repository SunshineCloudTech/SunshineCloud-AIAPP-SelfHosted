name: Backup Repository

on:
  push:
    branches:
      - main
  workflow_dispatch:
  schedule:
    # Run backup every Sunday at 2 AM UTC
    - cron: '0 2 * * 0'

permissions:
  contents: write
  actions: read

jobs:
  backup-repository:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history
        submodules: 'recursive'
        token: ${{ secrets.REPO_TOKEN }}

    - name: Get current date and time
      id: datetime
      run: |
        echo "timestamp=$(date +%Y%m%d_%H%M%S)" >> $GITHUB_OUTPUT
        echo "date=$(date +%Y-%m-%d)" >> $GITHUB_OUTPUT
        echo "commit_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

    - name: Create Backup Package
      run: |
        # Create backup directory
        mkdir -p backup
        
        # Create a comprehensive backup archive
        tar --exclude='.git' \
            --exclude='node_modules' \
            --exclude='*.log' \
            --exclude='__pycache__' \
            --exclude='.pytest_cache' \
            --exclude='backup' \
            --exclude='*.tmp' \
            --exclude='.vscode' \
            --exclude='.idea' \
            -czf backup/SunshineCloud-AIAPP-SelfHosted-${{ steps.datetime.outputs.timestamp }}.tar.gz \
            .
        
        # Create a git bundle as additional backup
        git bundle create backup/SunshineCloud-AIAPP-SelfHosted-${{ steps.datetime.outputs.timestamp }}.bundle --all
        
        # List created files
        ls -la backup/
        
        # Calculate checksums
        cd backup
        sha256sum *.tar.gz *.bundle > checksums.sha256
        cat checksums.sha256

    - name: Upload Backup Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: SunshineCloud-AIAPP-SelfHosted-backup-${{ steps.datetime.outputs.timestamp }}
        path: backup/
        retention-days: 30
    # Create GitHub Release with backup files
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          backup/SunshineCloud-AIAPP-SelfHosted-${{ steps.datetime.outputs.timestamp }}.tar.gz
          backup/SunshineCloud-AIAPP-SelfHosted-${{ steps.datetime.outputs.timestamp }}.bundle
          backup/checksums.sha256
        body: |
          ## ğŸ—„ï¸ SunshineCloud-AIAPP-SelfHosted Repository Backup
          
          **å¤‡ä»½æ—¥æœŸ:** ${{ steps.datetime.outputs.date }}
          **æäº¤ SHA:** ${{ steps.datetime.outputs.commit_sha }}
          **å¤‡ä»½æ–‡ä»¶:**
          
          - ğŸ“¦ `SunshineCloud-AIAPP-SelfHosted-${{ steps.datetime.outputs.timestamp }}.tar.gz` - å®Œæ•´æºä»£ç å­˜æ¡£
          - ğŸ”— `SunshineCloud-AIAPP-SelfHosted-${{ steps.datetime.outputs.timestamp }}.bundle` - Git ä»“åº“åŒ…
          - ğŸ” `checksums.sha256` - SHA256 æ ¡éªŒå’ŒéªŒè¯æ–‡ä»¶
          
          ### ğŸ“‹ å¤‡ä»½å†…å®¹
          - å®Œæ•´çš„æºä»£ç å’Œé…ç½®æ–‡ä»¶
          - AI/ML æœåŠ¡å®¹å™¨ (Stable Diffusion, ComfyUI, Fooocus, Text Generation)
          - VS Code Dev Container é…ç½®
          - å¼€å‘ç¯å¢ƒé…ç½®æ–‡ä»¶
          - GitHub Actions å·¥ä½œæµ
          - æ–‡æ¡£å’Œè®¸å¯è¯æ–‡ä»¶
          - CUDA å®‰è£…è„šæœ¬
          - åº”ç”¨ç¨‹åºå®‰è£…è„šæœ¬
          
          ### ğŸ” éªŒè¯å’Œä½¿ç”¨
          ```bash
          # éªŒè¯æ–‡ä»¶å®Œæ•´æ€§
          sha256sum -c checksums.sha256
          
          # è§£å‹å­˜æ¡£
          tar -xzf SunshineCloud-AIAPP-SelfHosted-${{ steps.datetime.outputs.timestamp }}.tar.gz
          
          # ä» bundle å…‹éš†
          git clone SunshineCloud-AIAPP-SelfHosted-${{ steps.datetime.outputs.timestamp }}.bundle restored-repo
          ```
          
          ### ğŸš€ é¡¹ç›®ç‰¹æ€§
          - AI/ML æ¡†æ¶é›†æˆ (Stable Diffusion, ComfyUI, Fooocus, Text Generation WebUI)
          - å®¹å™¨åŒ–éƒ¨ç½² (Docker, CUDA æ”¯æŒ)
          - è‡ªæ‰˜ç®¡ AI åº”ç”¨è§£å†³æ–¹æ¡ˆ
          - å®Œæ•´çš„é…ç½®å’Œè„šæœ¬å·¥å…·
          - è‡ªåŠ¨åŒ–æœåŠ¡ç®¡ç†
          
          ---
          *GitHub Actions è‡ªåŠ¨åˆ›å»ºçš„å¤‡ä»½*
        tag_name: backup-${{ steps.datetime.outputs.timestamp }}
        name: "Repository Backup - ${{ steps.datetime.outputs.date }}"
        draft: false
        prerelease: false
        token: ${{ secrets.REPO_TOKEN }}
        make_latest: false